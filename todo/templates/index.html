{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ğŸ“ My Todo App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="container topbar-content">
      <h1 class="logo">ğŸ“ My Todo App</h1>
      <button id="theme-toggle" class="btn small ghost">ğŸŒ™</button>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero container">
    <h2 class="hero-title">Organize Your Day</h2>
    <p class="hero-desc">Manage tasks, categories, and deadlines in a clean and modern dashboard.</p>
  </section>

  <main class="container main">
    <!-- Add & Filter Section -->
    <section class="card add-section elevated">
      <h3 class="section-title">Add Task</h3>
      <form method="POST" class="add-form">
        {% csrf_token %}
        {{ form.title }}
        {{ form.description }}
        {{ form.category }}
        {{ form.due_date }}
        <button type="submit" class="btn wide">â• Add Task</button>
      </form>

      <div class="flex-between">
        <!-- Filter Form -->
        <form method="GET" class="filter-form">
          <input name="q" placeholder="Search tasks..." value="{{ q }}">
          <select name="category">
            <option value="">All categories</option>
            {% for cat in categories %}
              <option value="{{ cat.id }}" {% if current_category|add:'' == cat.id|stringformat:"s" %}selected{% endif %}>
                {{ cat.name }}
              </option>
            {% endfor %}
          </select>
          <button class="btn ghost small">Filter</button>
        </form>

        <!-- Add Category Form -->
        <form method="POST" action="{% url 'add_category' %}" class="add-category-form">
          {% csrf_token %}
          <input name="name" placeholder="New category...">
          <button class="btn small">Add</button>
        </form>
      </div>
    </section>

    <!-- Tasks List -->
    <section class="card tasks elevated">
      <h3 class="section-title">Your Tasks</h3>
      <ul class="task-list">
        {% for task in tasks %}
          <li class="modern-task {% if task.completed %}done{% endif %}">
            <div class="left">
              <form method="POST" action="{% url 'toggle' task.id %}">
                {% csrf_token %}
                <button class="checkbox">{% if task.completed %}âœ”{% else %}â—‹{% endif %}</button>
              </form>
              <div class="task-text">
                <div class="title">{{ task.title }}</div>
                {% if task.description %}
                  <div class="description">{{ task.description|linebreaksbr }}</div>
                {% endif %}
                <div class="small">
                  {% if task.category %}<span class="chip">{{ task.category.name }}</span>{% endif %}
                  {% if task.due_date %}<span class="due">ğŸ•’ {{ task.due_date|date:"M j, Y H:i" }}</span>{% endif %}
                </div>
              </div>
            </div>
            <div class="task-actions">
              <a href="{% url 'edit' task.id %}" class="btn ghost small">âœ Edit</a>
              <form method="POST" action="{% url 'delete' task.id %}">
                {% csrf_token %}
                <button class="btn danger small">ğŸ—‘ Delete</button>
              </form>
            </div>
          </li>
        {% empty %}
          <p class="empty">âœ¨ No tasks yet â€” Add one above!</p>
        {% endfor %}
      </ul>

      <!-- Pagination -->
      {% if is_paginated %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn small ghost">â¬… Prev</a>
          {% endif %}

          {% for num in paginator.page_range %}
            {% if page_obj.number == num %}
              <span class="btn small accent">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <a href="?page={{ num }}{% if q %}&q={{ q }}{% endif %}" class="btn small ghost">{{ num }}</a>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn small ghost">Next â¡</a>
          {% endif %}
        </div>
      {% endif %}
    </section>

  </main>

  <!-- Theme Script -->
  <script>
    const toggle = document.getElementById("theme-toggle");
    const root = document.documentElement;

    function setTheme(mode) {
      if (mode === "dark") root.classList.add("dark");
      else root.classList.remove("dark");
      toggle.textContent = mode === "dark" ? "â˜€" : "ğŸŒ™";
      localStorage.setItem("theme", mode);
    }

    toggle.addEventListener("click", () => {
      const current = localStorage.getItem("theme") || 
        (root.classList.contains("dark") ? "dark" : "light");
      setTheme(current === "dark" ? "light" : "dark");
    });

    setTheme(localStorage.getItem("theme") || "light");
  </script>
</body>
</html>
